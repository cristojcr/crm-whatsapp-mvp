// tests/partnership-e2e-test.js
const axios = require('axios');

class PartnershipE2ETests {
    constructor() {
        this.baseURL = 'http://localhost:3001';
        this.testResults = [];
        this.testData = {
            partner: null,
            commission: null,
            referral: null
        };
    }
    
    async runCompletePartnershipFlow() {
        console.log('üéØ INICIANDO TESTE E2E - SISTEMA DE PARCERIAS');
        console.log('================================================');
        
        try {
            await this.testPartnerRegistration();
            await this.testReferralTracking();
            await this.testCommissionCalculation();
            await this.testAdminAPIs();
            await this.testNotificationSystem();
            
            this.generateFinalReport();
        } catch (error) {
            console.error('‚ùå Erro durante os testes:', error.message);
        }
    }
    
    async testPartnerRegistration() {
        console.log('\nüìã TESTE 1: CADASTRO DE PARCEIRO');
        console.log('--------------------------------');
        
        const testCases = [
            {
                name: 'Cadastro Contador',
                data: {
                    business_name: 'Escrit√≥rio Cont√°bil Teste',
                    contact_person: 'joana Silva',
                    email: 'joana.teste@email.com',
                    business_type: 'contador',
                    phone: '11999999999',
                    document: '12345678901'
                }
            },
            {
                name: 'Cadastro Associa√ß√£o',
                data: {
                    business_name: 'Associa√ß√£o Comercial Teste',
                    contact_person: 'Mario Santos',
                    email: 'mario.teste@email.com',
                    business_type: 'associacao',
                    phone: '11888888888',
                    document: '12345678000199'
                }
            }
        ];
        
        for (let testCase of testCases) {
            try {
                const response = await this.makeRequest('POST', '/api/partners/register', testCase.data);
                
                if (response.status === 201 || response.status === 200) {
                    console.log(`‚úÖ ${testCase.name}: SUCCESS`);
                    console.log(`   üìß Email: ${testCase.data.email}`);
                    console.log(`   üè¢ Tipo: ${testCase.data.business_type}`);
                    
                    // Salvar primeiro parceiro para testes posteriores
                    if (!this.testData.partner) {
                        this.testData.partner = response.data.partner;
                    }
                    
                    this.testResults.push({
                        test: testCase.name,
                        status: 'SUCCESS',
                        responseTime: response.responseTime,
                        details: `Partner ID: ${response.data.partner?.id || 'N/A'}`
                    });
                } else {
                    throw new Error(`Status ${response.status}`);
                }
            } catch (error) {
                console.log(`‚ùå ${testCase.name}: FAILED - ${error.message}`);
                this.testResults.push({
                    test: testCase.name,
                    status: 'FAILED',
                    error: error.message
                });
            }
        }
    }
    
    async testReferralTracking() {
        console.log('\nüîó TESTE 2: RASTREAMENTO DE REFER√äNCIAS');
        console.log('---------------------------------------');
        
        if (!this.testData.partner) {
            console.log('‚ö†Ô∏è Pulando teste: Nenhum parceiro dispon√≠vel');
            return;
        }
        
        const testCases = [
            {
                name: 'Tracking de Click',
                endpoint: '/api/partners/track-click',
                data: {
                    partner_code: this.testData.partner.partner_code,
                    source: 'website',
                    utm_campaign: 'test-campaign'
                }
            },
            {
                name: 'Registro de Convers√£o',
                endpoint: '/api/partners/track-conversion',
                data: {
                    partner_code: this.testData.partner.partner_code,
                    client_email: 'cliente.teste@email.com',
                    subscription_plan: 'basic',
                    conversion_value: 99.90
                }
            }
        ];
        
        for (let testCase of testCases) {
            try {
                const response = await this.makeRequest('POST', testCase.endpoint, testCase.data);
                
                if (response.status === 200 || response.status === 201) {
                    console.log(`‚úÖ ${testCase.name}: SUCCESS`);
                    console.log(`   üìä Partner Code: ${testCase.data.partner_code}`);
                    
                    this.testResults.push({
                        test: testCase.name,
                        status: 'SUCCESS',
                        responseTime: response.responseTime
                    });
                } else {
                    throw new Error(`Status ${response.status}`);
                }
            } catch (error) {
                console.log(`‚ùå ${testCase.name}: FAILED - ${error.message}`);
                this.testResults.push({
                    test: testCase.name,
                    status: 'FAILED',
                    error: error.message
                });
            }
        }
    }
    
    async testCommissionCalculation() {
        console.log('\nüí∞ TESTE 3: C√ÅLCULO DE COMISS√ïES');
        console.log('--------------------------------');
        
        const testCases = [
            {
                name: 'Processar Comiss√µes Mensais',
                endpoint: '/api/admin/commissions/process-monthly',
                data: {
                    year: new Date().getFullYear(),
                    month: new Date().getMonth() + 1
                }
            },
            {
                name: 'Listar Comiss√µes Pendentes',
                endpoint: '/api/admin/commissions/pending',
                method: 'GET'
            },
            {
                name: 'Relat√≥rio Financeiro',
                endpoint: '/api/admin/commissions/report',
                method: 'GET',
                params: {
                    start_date: '2024-01-01',
                    end_date: '2024-12-31'
                }
            }
        ];
        
        for (let testCase of testCases) {
            try {
                let response;
                
                if (testCase.method === 'GET') {
                    const url = testCase.params ? 
                        `${testCase.endpoint}?${new URLSearchParams(testCase.params).toString()}` : 
                        testCase.endpoint;
                    response = await this.makeRequest('GET', url);
                } else {
                    response = await this.makeRequest('POST', testCase.endpoint, testCase.data);
                }
                
                if (response.status === 200) {
                    console.log(`‚úÖ ${testCase.name}: SUCCESS`);
                    
                    if (testCase.name === 'Processar Comiss√µes Mensais' && response.data.commissions) {
                        console.log(`   üìä Comiss√µes processadas: ${response.data.commissions.length}`);
                        this.testData.commission = response.data.commissions[0];
                    }
                    
                    this.testResults.push({
                        test: testCase.name,
                        status: 'SUCCESS',
                        responseTime: response.responseTime
                    });
                } else {
                    throw new Error(`Status ${response.status}`);
                }
            } catch (error) {
                console.log(`‚ùå ${testCase.name}: FAILED - ${error.message}`);
                this.testResults.push({
                    test: testCase.name,
                    status: 'FAILED',
                    error: error.message
                });
            }
        }
    }
    
    async testAdminAPIs() {
        console.log('\nüîß TESTE 4: APIs ADMINISTRATIVAS');
        console.log('--------------------------------');
        
        const testCases = [
            {
                name: 'Listar Todos Parceiros',
                endpoint: '/api/partners/admin/list',         // ‚úÖ CORRETO
                method: 'GET'
            },
            {
                name: 'Dashboard de Parceiros',
                endpoint: '/api/partners/admin/dashboard',    // ‚úÖ CORRETO
                method: 'GET'
            },
            {
                name: 'Configura√ß√µes de Comiss√£o',
                endpoint: '/api/admin/partner-settings',
                method: 'GET'
            }
        ];
        
        for (let testCase of testCases) {
            try {
                const response = await this.makeRequest(testCase.method, testCase.endpoint);
                
                if (response.status === 200) {
                    console.log(`‚úÖ ${testCase.name}: SUCCESS`);
                    console.log(`   üìä Tempo: ${response.responseTime}ms`);
                    
                    this.testResults.push({
                        test: testCase.name,
                        status: 'SUCCESS',
                        responseTime: response.responseTime
                    });
                } else {
                    throw new Error(`Status ${response.status}`);
                }
            } catch (error) {
                console.log(`‚ùå ${testCase.name}: FAILED - ${error.message}`);
                this.testResults.push({
                    test: testCase.name,
                    status: 'FAILED',
                    error: error.message
                });
            }
        }
    }
    
    async testNotificationSystem() {
        console.log('\nüìß TESTE 5: SISTEMA DE NOTIFICA√á√ïES');
        console.log('----------------------------------');
        
        const testCases = [
            {
                name: 'Health Check Notifica√ß√µes',
                endpoint: '/api/partner-notifications/health',
                method: 'GET'
            },
            {
                name: 'Status do Sistema',
                endpoint: '/health',
                method: 'GET'
            }
        ];
        
        for (let testCase of testCases) {
            try {
                const response = await this.makeRequest(testCase.method, testCase.endpoint);
                
                if (response.status === 200) {
                    console.log(`‚úÖ ${testCase.name}: SUCCESS`);
                    console.log(`   üü¢ Status: ${response.data.status || 'healthy'}`);
                    
                    this.testResults.push({
                        test: testCase.name,
                        status: 'SUCCESS',
                        responseTime: response.responseTime
                    });
                } else {
                    throw new Error(`Status ${response.status}`);
                }
            } catch (error) {
                console.log(`‚ùå ${testCase.name}: FAILED - ${error.message}`);
                this.testResults.push({
                    test: testCase.name,
                    status: 'FAILED',
                    error: error.message
                });
            }
        }
    }
    
    async makeRequest(method, endpoint, data = null) {
        const startTime = Date.now();
        const url = `${this.baseURL}${endpoint}`;
        
        try {
            let response;
            
            const config = {
                timeout: 10000,
                headers: {
                    'Content-Type': 'application/json'
                }
            };
            
            if (method === 'GET') {
                response = await axios.get(url, config);
            } else if (method === 'POST') {
                response = await axios.post(url, data, config);
            } else if (method === 'PUT') {
                response = await axios.put(url, data, config);
            }
            
            return {
                status: response.status,
                data: response.data,
                responseTime: Date.now() - startTime
            };
        } catch (error) {
            return {
                status: error.response?.status || 500,
                error: error.message,
                responseTime: Date.now() - startTime
            };
        }
    }
    
    generateFinalReport() {
        console.log('\nüìä RELAT√ìRIO FINAL - SISTEMA DE PARCERIAS');
        console.log('=========================================');
        
        const totalTests = this.testResults.length;
        const successTests = this.testResults.filter(r => r.status === 'SUCCESS').length;
        const failedTests = this.testResults.filter(r => r.status === 'FAILED').length;
        const averageTime = this.testResults
            .filter(r => r.responseTime)
            .reduce((sum, r) => sum + r.responseTime, 0) / this.testResults.filter(r => r.responseTime).length;
        
        console.log(`üìà RESUMO GERAL:`);
        console.log(`   üß™ Total de testes: ${totalTests}`);
        console.log(`   ‚úÖ Sucessos: ${successTests} (${(successTests/totalTests*100).toFixed(1)}%)`);
        console.log(`   ‚ùå Falhas: ${failedTests} (${(failedTests/totalTests*100).toFixed(1)}%)`);
        console.log(`   ‚è±Ô∏è Tempo m√©dio: ${averageTime.toFixed(0)}ms`);
        
        console.log(`\nüìã DETALHES DOS TESTES:`);
        this.testResults.forEach((result, index) => {
            const icon = result.status === 'SUCCESS' ? '‚úÖ' : '‚ùå';
            console.log(`   ${icon} ${index + 1}. ${result.test} - ${result.responseTime || 'N/A'}ms`);
            if (result.error) {
                console.log(`      ‚ö†Ô∏è Erro: ${result.error}`);
            }
        });
        
        console.log(`\nüéØ AVALIA√á√ÉO FINAL:`);
        if (successTests / totalTests >= 0.8) {
            console.log('üü¢ SISTEMA DE PARCERIAS: APROVADO!');
            console.log('‚úÖ Pronto para produ√ß√£o');
        } else if (successTests / totalTests >= 0.6) {
            console.log('üü° SISTEMA DE PARCERIAS: PARCIALMENTE FUNCIONAL');
            console.log('‚ö†Ô∏è Revisar falhas antes do deploy');
        } else {
            console.log('üî¥ SISTEMA DE PARCERIAS: NECESSITA CORRE√á√ïES');
            console.log('‚ùå Muitas falhas detectadas');
        }
        
        console.log('\n=========================================');
        console.log('üéä TESTE E2E CONCLU√çDO!');
    }
}

// Executar testes E2E
const partnershipTests = new PartnershipE2ETests();
partnershipTests.runCompletePartnershipFlow();