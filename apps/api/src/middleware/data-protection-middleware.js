// apps/api/src/middleware/data-protection-middleware.js
const DataProtectionService = require('../services/data-protection-service');

class DataProtectionMiddleware {
    
    // ========================================
    // MIDDLEWARE PRINCIPAL DE AUDITORIA
    // ========================================
    
    static auditMiddleware(req, res, next) {
        // Capturar dados da requisi√ß√£o
        const originalSend = res.send;
        const startTime = Date.now();
        
        // Interceptar resposta
        res.send = function(data) {
            const endTime = Date.now();
            const duration = endTime - startTime;
            
            // Log autom√°tico para opera√ß√µes sens√≠veis
            DataProtectionMiddleware.logSensitiveOperation(req, res, duration);
            
            // Restaurar fun√ß√£o original e enviar resposta
            res.send = originalSend;
            return originalSend.call(this, data);
        };
        
        next();
    }
    
    // ========================================
    // MIDDLEWARE DE PROTE√á√ÉO DE DADOS
    // ========================================
    
    static async dataProtectionMiddleware(req, res, next) {
        try {
            const sensitiveOperations = ['POST', 'PUT', 'PATCH', 'DELETE'];
            const sensitiveEndpoints = [
                '/users', '/contacts', '/companies', '/messages', 
                '/conversations', '/appointments', '/user-profiles'
            ];
            
            const isSensitive = sensitiveOperations.includes(req.method) &&
                sensitiveEndpoints.some(endpoint => req.path.includes(endpoint));
            
            if (isSensitive) {
                console.log(`üîí Opera√ß√£o sens√≠vel detectada: ${req.method} ${req.path}`);
                
                // Verificar consentimentos se necess√°rio
                if (req.user?.id && req.method !== 'DELETE') {
                    const hasConsent = await DataProtectionService.checkConsent(
                        req.user.id,
                        'data_processing'
                    );
                    
                    if (!hasConsent && !req.path.includes('/consent')) {
                        return res.status(403).json({
                            error: 'Consentimento necess√°rio para processamento de dados',
                            code: 'CONSENT_REQUIRED',
                            regulation: 'LGPD/GDPR',
                            action_required: 'Solicite consentimento do usu√°rio'
                        });
                    }
                }
                
                // Marcar para auditoria espec√≠fica
                req.auditEventType = 'data_modification';
                req.requiresCompliance = true;
            }
            
            next();
        } catch (error) {
            console.error('‚ùå Erro no middleware de prote√ß√£o de dados:', error);
            next(); // Continuar mesmo com erro para n√£o quebrar a aplica√ß√£o
        }
    }
    
    // ========================================
    // MIDDLEWARE DE CONTROLE DE ACESSO GDPR
    // ========================================
    
    static gdprAccessControl(requiredRole = 'COMPLIANCE_OFFICER') {
        return async (req, res, next) => {
            try {
                // Verificar se usu√°rio tem permiss√£o para opera√ß√µes GDPR
                if (!req.user) {
                    return res.status(401).json({
                        error: 'Autentica√ß√£o necess√°ria',
                        code: 'AUTH_REQUIRED'
                    });
                }
                
                // Para admins, verificar role espec√≠fica
                if (req.user.role && req.user.role !== requiredRole && req.user.role !== 'SUPER_ADMIN') {
                    return res.status(403).json({
                        error: 'Permiss√£o insuficiente para opera√ß√µes GDPR/LGPD',
                        code: 'INSUFFICIENT_PERMISSIONS',
                        required_role: requiredRole
                    });
                }
                
                console.log(`‚úÖ Acesso GDPR autorizado para usu√°rio ${req.user.id}`);
                next();
            } catch (error) {
                console.error('‚ùå Erro no controle de acesso GDPR:', error);
                return res.status(500).json({
                    error: 'Erro interno na verifica√ß√£o de permiss√µes'
                });
            }
        };
    }
    
    // ========================================
    // MIDDLEWARE DE VALIDA√á√ÉO DE SOLICITA√á√ïES
    // ========================================
    
    static validateDataSubjectRequest(req, res, next) {
        try {
            const { request_type, requester_email, description } = req.body;
            
            // Valida√ß√µes obrigat√≥rias
            if (!request_type) {
                return res.status(400).json({
                    error: 'Tipo de solicita√ß√£o √© obrigat√≥rio',
                    code: 'MISSING_REQUEST_TYPE',
                    valid_types: ['access', 'rectification', 'erasure', 'portability', 'restriction', 'objection']
                });
            }
            
            if (!requester_email) {
                return res.status(400).json({
                    error: 'Email do solicitante √© obrigat√≥rio',
                    code: 'MISSING_REQUESTER_EMAIL'
                });
            }
            
            if (!description) {
                return res.status(400).json({
                    error: 'Descri√ß√£o da solicita√ß√£o √© obrigat√≥ria',
                    code: 'MISSING_DESCRIPTION'
                });
            }
            
            // Validar formato do email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(requester_email)) {
                return res.status(400).json({
                    error: 'Formato de email inv√°lido',
                    code: 'INVALID_EMAIL_FORMAT'
                });
            }
            
            // Validar tipo de solicita√ß√£o
            const validTypes = ['access', 'rectification', 'erasure', 'portability', 'restriction', 'objection', 'consent_withdrawal'];
            if (!validTypes.includes(request_type)) {
                return res.status(400).json({
                    error: 'Tipo de solicita√ß√£o inv√°lido',
                    code: 'INVALID_REQUEST_TYPE',
                    valid_types: validTypes
                });
            }
            
            console.log(`‚úÖ Solicita√ß√£o GDPR validada: ${request_type} para ${requester_email}`);
            next();
        } catch (error) {
            console.error('‚ùå Erro na valida√ß√£o de solicita√ß√£o:', error);
            return res.status(500).json({
                error: 'Erro interno na valida√ß√£o'
            });
        }
    }
    
    // ========================================
    // LOGGING E AUDITORIA
    // ========================================
    
    static async logSensitiveOperation(req, res, duration) {
        try {
            // Determinar se √© opera√ß√£o que precisa de log detalhado
            const sensitiveOperations = ['POST', 'PUT', 'PATCH', 'DELETE'];
            const sensitiveEndpoints = [
                '/users', '/contacts', '/companies', '/messages',
                '/data-subject-requests', '/consent', '/data-breach'
            ];
            
            const isSensitive = sensitiveOperations.includes(req.method) &&
                sensitiveEndpoints.some(endpoint => req.path.includes(endpoint));
            
            if (isSensitive || req.requiresCompliance) {
                const logData = {
                    method: req.method,
                    path: req.path,
                    user_id: req.user?.id || null,
                    ip_address: req.ip,
                    user_agent: req.get('User-Agent'),
                    status_code: res.statusCode,
                    duration_ms: duration,
                    timestamp: new Date().toISOString()
                };
                
                // N√£o incluir dados sens√≠veis no log, apenas metadata
                if (req.body && !req.path.includes('/auth')) {
                    logData.has_body = true;
                    logData.body_keys = Object.keys(req.body);
                }
                
                await DataProtectionService.logComplianceEvent(
                    req.auditEventType || 'api_access',
                    logData,
                    req.user?.id
                );
            }
        } catch (error) {
            console.error('‚ùå Erro ao registrar log de opera√ß√£o:', error);
        }
    }
    
    // ========================================
    // MIDDLEWARE DE RATE LIMITING GDPR
    // ========================================
    
    static gdprRateLimit() {
        const requests = new Map();
        
        return (req, res, next) => {
            try {
                const identifier = req.user?.id || req.ip;
                const now = Date.now();
                const windowMs = 60 * 60 * 1000; // 1 hora
                const maxRequests = 10; // M√°ximo 10 solicita√ß√µes GDPR por hora
                
                if (!requests.has(identifier)) {
                    requests.set(identifier, []);
                }
                
                const userRequests = requests.get(identifier);
                
                // Limpar requisi√ß√µes antigas
                const validRequests = userRequests.filter(timestamp => now - timestamp < windowMs);
                requests.set(identifier, validRequests);
                
                if (validRequests.length >= maxRequests) {
                    return res.status(429).json({
                        error: 'Muitas solicita√ß√µes GDPR/LGPD',
                        code: 'GDPR_RATE_LIMIT_EXCEEDED',
                        retry_after: '1 hour',
                        max_requests: maxRequests
                    });
                }
                
                // Adicionar esta requisi√ß√£o
                validRequests.push(now);
                requests.set(identifier, validRequests);
                
                next();
            } catch (error) {
                console.error('‚ùå Erro no rate limiting GDPR:', error);
                next(); // Continuar em caso de erro
            }
        };
    }
    
    // ========================================
    // UTILIT√ÅRIOS
    // ========================================
    
    static sanitizeResponse(data) {
        // Remover campos sens√≠veis de respostas quando necess√°rio
        if (typeof data === 'object' && data !== null) {
            const sanitized = { ...data };
            
            // Campos que nunca devem aparecer em respostas
            const sensitiveFields = ['password', 'password_hash', 'api_key_hash', 'two_factor_secret'];
            
            sensitiveFields.forEach(field => {
                if (field in sanitized) {
                    delete sanitized[field];
                }
            });
            
            return sanitized;
        }
        
        return data;
    }
}

module.exports = DataProtectionMiddleware;